http://stackoverflow.com/questions/33986863/mocha-api-testing-getting-typeerror-app-address-is-not-a-function

module.exportsをmodule.exportにしてた。だってVSCなんかmodule.exportの時に色がつくんだぜ・・・辛い

```
     Error: timeout of 2000ms exceeded. Ensure the done() callback is being called in this test.
      at Timeout.<anonymous> (C:\Users\user\AppData\Roaming\nvm\v6.1.0\node_modules\mocha\lib\runnable.js:226:19)
      ```
      
# supertest

supertestでテストするときはexpressをインスタンス化しなきゃいけない。ルーティングだけじゃなくてね。

あとdoneが発行されると正常に通ったとみなされる。
expect内は失敗しても必ず次に行くのでdone()として発行してはいけない。

supertestは２つ以上コールバックすると落ちる。double callback

```
  GET /user
double callback!
double callback!
double callback!
    1) response is json and format is true


  0 passing (111ms)
  1 failing

  1) GET /user response is json and format is true:
     TypeError: Cannot read property 'header' of undefined
      at Test._assertHeader (c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modules\supertest\lib\test.js:208:19)
      at Test._assertFunction (c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modules\supertest\lib\test.js:247:11)
      at Test.assert (c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modules\supertest\lib\test.js:148:18)
      at Server.assert (c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modules\supertest\lib\test.js:127:12)
      at emitCloseNT (net.js:1549:8)
      at _combinedTickCallback (internal/process/next_tick.js:71:11)
      at process._tickCallback (internal/process/next_tick.js:98:9)


```

doneを発行しても後ろのテストも実行される。

```

describe("GET /user", () => {
    it("response is json and format is true", (done) => {
        request(app)
            .get('/user')
            .expect('Content-Type', /json/)
            .expect('Content-Length', '15')
            .expect(200,done)
            .expect(400);

    })
});

```

結果ｗｗｗｗ

```
    Error: expected 400 "Bad Request", got 200 "OK"
      at Test._assertStatus (c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modules\supertest\lib\test.js:232:12)
      at Test._assertFunction (c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modules\supertest\lib\test.js:247:11)
      at Test.assert (c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modules\supertest\lib\test.js:148:18)
      at Server.assert (c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modules\supertest\lib\test.js:127:12)
      at emitCloseNT (net.js:1549:8)
      at _combinedTickCallback (internal/process/next_tick.js:71:11)
      at process._tickCallback (internal/process/next_tick.js:98:9)

```

# まとめ

doneが白化したら終わり
expectはokだったらdoneを発行させる。
expectは引数をとってテストする。引数を取る時点で発火させたら終わり。


# supertestのソースを読む

やっぱ中身でsuperagentを使ってるな。
バグ踏んで調べまくってる時によく目にした。

expectの返り値(`request().get()`の返り値？)にはTestオブジェクトがかえってくる。

```

  GET /user
Test {
  domain: null,
  _events: { end: [Function: bound _clearTimeout] },
  _eventsCount: 1,
  _maxListeners: undefined,
  _agent: false,
  _formData: null,
  method: 'get',
  url: 'http://127.0.0.1:54677/user',
  _header: { 'user-agent': 'node-superagent/1.8.3' },
  header: { 'User-Agent': 'node-superagent/1.8.3' },
  writable: true,
  _redirects: 0,
  _maxRedirects: 0,
  cookies: '',
  qs: {},
  qsRaw: [],
  _redirectList: [],
  _streamRequest: false,
  _buffer: true,
  app:
   Server {
     domain: null,
     _events:
      { request: [Object],
        connection: [Function: connectionListener] },
     _eventsCount: 2,
     _maxListeners: undefined,
     _connections: 0,
     _handle:
      TCP {
        bytesRead: 0,
        _externalStream: {},
        fd: -1,
        reading: false,
        owner: [Circular],
        onread: null,
        onconnection: [Function: onconnection],
        writeQueueSize: 0 },
     _usingSlaves: false,
     _slaves: [],
     _unref: false,
     allowHalfOpen: true,
     pauseOnConnect: false,
     httpAllowHalfOpen: false,
     timeout: 120000,
     _pendingResponseData: 0,
     _connectionKey: '6::::0' },
  _asserts: [ [Function: bound ], [Function: bound ] ],
  _server:
   Server {
     domain: null,
     _events:
      { request: [Object],
        connection: [Function: connectionListener] },
     _eventsCount: 2,
     _maxListeners: undefined,
     _connections: 0,
     _handle:
      TCP {
        bytesRead: 0,
        _externalStream: {},
        fd: -1,
        reading: false,
        owner: [Circular],
        onread: null,
        onconnection: [Function: onconnection],
        writeQueueSize: 0 },
     _usingSlaves: false,
     _slaves: [],
     _unref: false,
     allowHalfOpen: true,
     pauseOnConnect: false,
     httpAllowHalfOpen: false,
     timeout: 120000,
     _pendingResponseData: 0,
     _connectionKey: '6::::0' } }

```

```   
console.log(        request(app)
            .get('/user'))   
            ```
            
 # supertestのソース
 
 Testオブジェクトがある。その中にprototypeでexpectが入ってる。
 
 ```
 
/**
 * Expectations:
 *
 *   .expect(200)
 *   .expect(200, fn)
 *   .expect(200, body)
 *   .expect('Some body')
 *   .expect('Some body', fn)
 *   .expect('Content-Type', 'application/json')
 *   .expect('Content-Type', 'application/json', fn)
 *   .expect(fn)
 *
 * @return {Test}
 * @api public
 */

Test.prototype.expect = function(a, b, c){
  // callback
 ```
 
 _assertsにpushして後で実行してる。
 
 # Heroku Toolbelt Windows Updater.rb:60 undefined method `[]`
 
 heroku toolbelt.
 
 なんかよくわからんけどcppが逝ってる。
 
 再インストールしたら治った。なんだこれ
 
 # postが処理できない
 
 
 body perserとかいうミドルウェアが必要っぽい
 
 ```
 var bodyParser = require('body-parser');
app.use(express.bodyParser());
```


# oracledb インストール時にnode-gypによるbuildができない

https://github.com/oracle/node-oracledb/issues/31

oracle-clientが必要・・？

oracle instance clientが必要。こいつがclient側のコントロールをする。


```

c:\Users\user\Desktop\g\GeckoLion\telma_server>npm install oracledb --save-dev

> oracledb@1.9.3 install c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modules\oracledb
> node-gyp rebuild


c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modules\oracledb>if not defined npm_config_node_gyp (node "C:\Users\user\AppData\Roaming\nvm\v6.1.0\node_modules\npm\bin\node-gyp-bin\\..\..\node_modules\node-gyp\bin\node-gyp.js" rebuild )  else (node "" rebuild )
Building the projects in this solution one at a time. To enable parallel build, please add the "/m" switch.
  njsOracle.cpp
c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modules\oracledb\src\dpi\include\dpiStmt.h(30): fatal error C1083:
Cannot open include file: 'oci.h': No such file or directory [c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modul
es\oracledb\build\oracledb.vcxproj]
  njsPool.cpp
c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modules\oracledb\src\dpi\include\dpiStmt.h(30): fatal error C1083:
Cannot open include file: 'oci.h': No such file or directory [c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modul
es\oracledb\build\oracledb.vcxproj]
  njsConnection.cpp
c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modules\oracledb\src\dpi\include\dpiStmt.h(30): fatal error C1083:
Cannot open include file: 'oci.h': No such file or directory [c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modul
es\oracledb\build\oracledb.vcxproj]
  njsResultSet.cpp
c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modules\oracledb\src\dpi\include\dpiStmt.h(30): fatal error C1083:
Cannot open include file: 'oci.h': No such file or directory [c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modul
es\oracledb\build\oracledb.vcxproj]
  njsMessages.cpp
  njsIntLob.cpp
c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modules\oracledb\src\dpi\include\dpiStmt.h(30): fatal error C1083:
Cannot open include file: 'oci.h': No such file or directory [c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modul
es\oracledb\build\oracledb.vcxproj]
  dpiEnv.cpp
c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modules\oracledb\src\dpi\src\dpiEnvImpl.h(30): fatal error C1083: C
annot open include file: 'oci.h': No such file or directory [c:\Users\user\Desktop\g\GeckoLion\telma_server\node_module
s\oracledb\build\oracledb.vcxproj]
  dpiEnvImpl.cpp
c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modules\oracledb\src\dpi\src\dpiEnvImpl.h(30): fatal error C1083: C
annot open include file: 'oci.h': No such file or directory [c:\Users\user\Desktop\g\GeckoLion\telma_server\node_module
s\oracledb\build\oracledb.vcxproj]
  dpiException.cpp
  dpiExceptionImpl.cpp
  dpiConnImpl.cpp
c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modules\oracledb\src\dpi\src\dpiConnImpl.h(30): fatal error C1083:
Cannot open include file: 'oci.h': No such file or directory [c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modul
es\oracledb\build\oracledb.vcxproj]
  dpiDateTimeArrayImpl.cpp
c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modules\oracledb\src\dpi\src\dpiUtils.h(30): fatal error C1083: Can
not open include file: 'oci.h': No such file or directory [c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modules\
oracledb\build\oracledb.vcxproj]
  dpiPoolImpl.cpp
c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modules\oracledb\src\dpi\src\dpiEnvImpl.h(30): fatal error C1083: C
annot open include file: 'oci.h': No such file or directory [c:\Users\user\Desktop\g\GeckoLion\telma_server\node_module
s\oracledb\build\oracledb.vcxproj]
  dpiStmtImpl.cpp
c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modules\oracledb\src\dpi\include\dpiStmt.h(30): fatal error C1083:
Cannot open include file: 'oci.h': No such file or directory [c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modul
es\oracledb\build\oracledb.vcxproj]
  dpiUtils.cpp
c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modules\oracledb\src\dpi\src\dpiUtils.h(30): fatal error C1083: Can
not open include file: 'oci.h': No such file or directory [c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modules\
oracledb\build\oracledb.vcxproj]
  dpiLob.cpp
c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modules\oracledb\src\dpi\src\dpiUtils.h(30): fatal error C1083: Can
not open include file: 'oci.h': No such file or directory [c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modules\
oracledb\build\oracledb.vcxproj]
  dpiCommon.cpp
..\src\dpi\src\dpiCommon.cpp(28): fatal error C1083: Cannot open include file: 'oci.h': No such file or directory [c:\U
sers\user\Desktop\g\GeckoLion\telma_server\node_modules\oracledb\build\oracledb.vcxproj]
gyp ERR! build error
gyp ERR! stack Error: `C:\Program Files (x86)\MSBuild\14.0\bin\msbuild.exe` failed with exit code: 1
gyp ERR! stack     at ChildProcess.onExit (C:\Users\user\AppData\Roaming\nvm\v6.1.0\node_modules\npm\node_modules\node-gyp\lib\build.js:276:23)
gyp ERR! stack     at emitTwo (events.js:106:13)
gyp ERR! stack     at ChildProcess.emit (events.js:191:7)
gyp ERR! stack     at Process.ChildProcess._handle.onexit (internal/child_process.js:204:12)
gyp ERR! System Windows_NT 10.0.10586
gyp ERR! command "C:\\Program Files\\nodejs\\node.exe" "C:\\Users\\user\\AppData\\Roaming\\nvm\\v6.1.0\\node_modules\\npm\\node_modules\\node-gyp\\bin\\node-gyp.js" "rebuild"
gyp ERR! cwd c:\Users\user\Desktop\g\GeckoLion\telma_server\node_modules\oracledb
gyp ERR! node -v v6.1.0
gyp ERR! node-gyp -v v3.3.1
gyp ERR! not ok
npm ERR! Windows_NT 10.0.10586
npm ERR! argv "C:\\Program Files\\nodejs\\node.exe" "C:\\Program Files\\nodejs\\node_modules\\npm\\bin\\npm-cli.js" "install" "oracledb" "--save-dev"
npm ERR! node v6.1.0
npm ERR! npm  v3.8.6
npm ERR! code ELIFECYCLE

npm ERR! oracledb@1.9.3 install: `node-gyp rebuild`
npm ERR! Exit status 1
npm ERR!
npm ERR! Failed at the oracledb@1.9.3 install script 'node-gyp rebuild'.
npm ERR! Make sure you have the latest version of node.js and npm installed.
npm ERR! If you do, this is most likely a problem with the oracledb package,
npm ERR! not with npm itself.
npm ERR! Tell the author that this fails on your system:
npm ERR!     node-gyp rebuild
npm ERR! You can get information on how to open an issue for this project with:
npm ERR!     npm bugs oracledb
npm ERR! Or if that isn't available, you can get their info via:
npm ERR!     npm owner ls oracledb
npm ERR! There is likely additional logging output above.

npm ERR! Please include the following file with any support request:
npm ERR!     c:\Users\user\Desktop\g\GeckoLion\telma_server\npm-debug.log

```

# SQL

sqlとかくっそ久しぶりに書いた。

`mysql> CREATE TABLE `autoi`(`id` int(11) NOT NULL PRIMARY KEY auto_increment)`

という表を作る。これにinsert intoするには適当にvalues('1111111111')<-11ケタ
~~~としても跳ね返される~~~

というのは嘘。なんかint11で10ケタなら行けた。謎い。さらにその以下の桁数でも普通に行ける・・・さっきできなかった・・・

# syntax

列名をバッククォートで囲んで値をシングルクォーテーションで囲むこと。

さもないと
```
mysql> insert into 'autoi'(id) values('35');
ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ''autoi'(id) values('35')' at line 1
```
というエラーが出る（出た

列名をバッククォートでvaluesをバッククォートでもダメ

```
ERROR 1054 (42S22): Unknown column '354' in 'field list'
```

列名と勘違いしてるな・・・

# alter table varchar

<<<<<<< HEAD
varchar(10);だとダメだったがvarchar(5)だといけた・・・
=======
varchar(10);だとダメだったがvarchar(5)だといけた・・・

# deploy on heroku

application error(error code H10)がめっちゃ出た

* Procfileがない

そういえばProcfileとか必要だったなあ。くっそ久しぶりに触ったので完全に忘れてた。

* package.jsonのdependenciesがない

npm install XXXXXX --save-devでやるとpackage.jsonにdevDependenciesがauto updateされるが、

heroku アップロード時にheroku鯖が自動でライブラリたちを落としてくるにはにはdevDependenciesじゃなくてdependenciesに依存ライブラリを記述する必要がある。

# Block-scoped declarations (let, const, function, class) not yet supported outside strict mode

死ね

"use strict"使って解決

# rest param was not found

死ね

```

2016-06-23T07:22:12.804900+00:00 app[web.1]: SyntaxError: Unexpected token ...

2016-06-23T07:22:12.804901+00:00 app[web.1]:     at exports.runInThisContext (vm.js:53:16)

2016-06-23T07:22:12.804901+00:00 app[web.1]:     at Module._compile (module.js:374:25)

2016-06-23T07:22:12.804907+00:00 app[web.1]:     at Object.Module._extensions..js (module.js:405:10)

2016-06-23T07:22:12.804908+00:00 app[web.1]:     at Module.load (module.js:344:32)

2016-06-23T07:22:12.804909+00:00 app[web.1]:     at Function.Module._load (module.js:301:12)

2016-06-23T07:22:12.804909+00:00 app[web.1]:     at Module.require (module.js:354:17)

2016-06-23T07:22:12.804910+00:00 app[web.1]:     at require (internal/module.js:12:17)

2016-06-23T07:22:12.804910+00:00 app[web.1]:     at Object.<anonymous> (/app/router.js:1:75)

2016-06-23T07:22:12.804911+00:00 app[web.1]:     at Module._compile (module.js:398:26)

2016-06-23T07:22:12.804911+00:00 app[web.1]:     at Object.Module._extensions..js (module.js:405:10)

2016-06-23T07:22:13.719038+00:00 heroku[web.1]: Process exited with status 1

2016-06-23T07:22:13.697679+00:00 heroku[web.1]: State changed from starting to crashed

2016-06-23T07:22:15.298079+00:00 heroku[router]: at=error code=H10 desc="App crashed" method=GET path="/" host=it2-sotu
```
>>>>>>> 50911f7a0e2aca0270726d8bd795fabac125afef
